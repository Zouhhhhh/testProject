# Spring的事务相关
- 事务管理器DataSourceTransactionManager
- 事务定义TransactionDefinition
- 事务状态TransactionStatus

# 1， 编程式事务
编程式事务以代码的方式管理事务（就是要自己commit，rollback）
```java
    try {
        // 通过jdbcTemplate，执行SQL语句
        // jdbcTemplate本身的数据库资源已经由事务管理器管理，因此当它执行完insert语句时不会自动提交。
        jdbcTemplate.update("INSERT INTO role (role_name, note) VALIES('role_name_transaction', 'note_transaction')");
        // 提交事务
        transactionManager.commit(status);
    } catch (Exception e) {
        transactionManager.rollback(status);
    }
```


# 2. 声明式事务
Spring给了一个约定（AOP开发也给了我们一个约定），如果使用的是声明式事务，那么当业务方法不发生异常（或者发生异常，该异常也被配置信息允许提交事务）时，Spring就会让事务管理器提交事务，而发生异常时，则回滚。

首先，编程式事务允许自定义事务接口——TransactionDefinition，它可以由XML或注解@Transactional进行配置。

## 2.1 Transactional的配置项

| 配置项                 | 含义                     | 备注                                                         |
| ---------------------- | ------------------------ | ------------------------------------------------------------ |
| value                  | 定义事务管理器           | 它是Spring IOC容器里的一个Bean id，这个Bean需要实现接口PlatformTransactionManager |
| transactionManager     | 同上                     | 同上                                                         |
| isolation              | 隔离级别                 | 这是一个数据库在多个事务同时存在时的概念，默认值取数据库默认隔离级别 |
| propagation            | 传播行为                 | 传播行为是方法之间调用的 问题，默认值为Proppagation.REQUIRED |
| timeout                | 超时时间                 | 单位为秒，当超时会引发异常，默认会导致事务回滚               |
| readOnly               | 是否开启只读事务         | 默认值为false                                                |
| rollbackFor            | 回滚事务的异常类定义     | 也就是只有当方法产生所定义异常时，才回滚事务，否则就提交事务 |
| rollbackForClassName   | 回滚事务的异常类名定义   | 同rollbackFor，只是使用类名称定义                            |
| noRollbackFor          | 当产生哪些异常不回滚事务 |                                                              |
| noRollbackForClassName | 同上                     |                                                              |

重点是isolation和propagation。注意，使用声明式事务需要配置**注解驱动**， 只需要在配置文件中加入配置

```xml
<tx:annotation-driven transaction-manager="transactionManager"/>
```

## 2.2 使用XML声明式事务配置
一种通用的XML声明式事务配置，它却在一定流程上揭露了事务管理器的内部实现。它需要一个事务拦截器——TransactionInterceptor，可以把拦截器想象成AOP编程

```xml
<!-- 拦截器 -->
<bean id="transactionInterceptor" class="org.springframework.transaction.interceptor.TransactionInterceptor">
    <property name="transactionManager" ref="transactionManager"/>
    
    <!-- 配置transactionAttributes的内容，Spring IOC启动时会解析这些内容，放到事务定义类TransactionDefinition中，在运行时会根据正则式的匹配决定方法采用哪种策略 -->
    <property name="transactionAttributes">
        <props>
            <!-- key代表的是业务方法的正则式匹配，而其余内容可以配置各类事务定义参数 -->
            <prop key="insert *">PROPAGATION_REQUIRED, ISOLATION_READ_UNCOMMITTED</prop>
            <prop key="save*">PROPAGATION_REQUIRED, ISOLATION_READ_UNCOMMITTED</prop>
            <prop key="add*">PROPAGATION_REQUIRED, ISOLATION_READ_UNCOMMITTED</prop>
            <prop key="select*">PROPAGATION_REQUIRED, readOnly</prop>
            <prop key="get*">PROPAGATION_REQUIRED, readOnly</prop>
            <prop key="find*">PROPAGATION_REQUIRED, readOnly</prop>
            <prop key="del*">PROPAGATION_REQUIRED, ISOLATION_READ_UNCOMMITTED</prop>
            <prop key="remove*">PROPAGATION_REQUIRED, ISOLATION_READ_UNCOMMITTED</prop>
            <prop key="update*">PROPAGATION_REQUIRED, ISOLATION_READ_UNCOMMITTED</prop>
        </props>
    </property>
</bean>

<!-- 拦截类 -->
<bean class="org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator">
    <property name="beanNames">
        <list>
            <value>*ServiceImpl</value>
        </list>
    </property>
    <property name="interceptorNames">
        <list>
            <value>transactionInterceptor</value>
        </list>
    </property>
</bean>
```

## 2.3 事务定义器(TransactionDefinition)


## 2.4 声明式事务的约定流程
首先Spring通过**事务管理器**（PlatformTransactionManager的子类）创建事务，与此同时会把**事务定义**中的隔离级别、超时时间等属性根据配置内容（配置类或者XML）设置到**事务**中。
然后启动开发者提供的业务代码，Spring给的约定是只要发生异常，并且符合事务定义类回滚条件的，Spring就会将数据库事务回滚，否则将数据库事务提交。


# 3. 选择隔离级别和传播行为







